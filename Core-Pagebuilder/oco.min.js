var maplace;function refreshLookups(){for(var e=JSON.parse($("#lookup_config").text()),t=0;t<e.length;t++)get_data(e[t])}function picklist(e){console.log("picked!"),console.log(e.id),console.log(e.value),$("#"+e.id+".config").html(e.value),refreshLookups()}function pickdate(e,t,a){$("#daterangestart").html(e.format("YYYY-MM-DD")),$("#daterangeend").html(t.format("YYYY-MM-DD")),refreshLookups()}function hideswitch(e){$(e).hasClass("on")?($("."+$(e).attr("id")).hide(500),$(e).removeClass("on")):($("."+$(e).attr("id")).show(500),$(e).addClass("on"))}function tablefilter(e){console.log(e),console.log($(e).attr("data-tableid")),console.log($(e).attr("data-tablefilter")),$("#"+$(e).attr("data-tableid")+" .results th select").val($(e).attr("data-tablefilter")).trigger("change")}function copyToClipboard(e){var t=$("<input>");$("body").append(t),t.val($(e).text().trim()).select(),console.log("copying "+$(e).text().trim()),document.execCommand("copy"),t.remove()}function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function escapeRegExp(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function unpack(e,t){return $.map(e,function(e){return e[t]})}function get_data(e,t){if(sid=void 0!==parent.FS&&null!==parent.FS&&null!==(ref=parent.FS.Auth)?ref.session["auth-session"]:void 0,void 0!==parent.FS.Auth.session.user||0!=$("#ucrn.config").length&&""==$("#ucrn.config").html().replace(/&nbsp;$/,"")){var a="undefined"!=typeof sid&&void 0!==parent.FS.Auth.session.user&&null!==parent.FS.Auth.session.user?parent.FS.Auth.session.user.email:"",n="undefined"!=typeof sid&&void 0!==parent.FS.Auth.session.user&&null!==parent.FS.Auth.session.user?parent.FS.Auth.session.user.attributes.ucrn:"";$("."+e.tab+".refreshbutton.unbound").on("click",function(){get_data(e),$("i",this).rotate({count:4,duration:.6,easing:"ease-out"})}).removeClass("unbound");var o=$("#"+e.table).html();void 0===o&&(o="");var s={};"object"==typeof t&&(s=t),$(".config").map(function(){"lookup_config"!=this.id&&(s[this.id]=$(this).html().replace(/&nbsp;$/,""))}),s.Email_Address=a,s.user_email=a,s.ucrn=n,$("#"+e.tab+" .spinner").show(),$("#"+e.tab+" .spinner .msg").html("Getting data...").show(),run_lookup(e.lookup,s,function(t){draw_results(t,e)},function(t){log_error(e.tab,t)})}else{$("#"+e.tab+" .spinner").show();var r=parent.window.location.origin+"/login/?return_url="+encodeURIComponent(parent.window.location.pathname+parent.window.location.search+parent.window.location.hash);$("#"+e.tab+" .spinner .msg").html('User details not found. Please refresh, or click "Home" and then the browser "Back" button, or <a href="'+r+'" target="_parent">log in</a>.').show()}}function render_url(e,t,a,n){var o=n.settings.aoColumns[n.col].title,s="";return"view"==o&&(o='<i class="fas fa-eye"></i>',o='<button type="button" class="btn btn-info btn-sm">View</button>',s="font-size:150%"),"edit"==o&&(o='<button type="button" class="btn btn-success btn-sm">Edit</button>',s="font-size:150%"),"display"!==t||0!==e&&""!==e&&null!==e?'<a target="_parent" title="'+n.settings.aoColumns[n.col].title+'"style="'+s+'" href="'+e+'">'+o+"</a>":e}function render_response(e,t,a,n){var o=e;if("display"===t){var s,r=new $.fn.dataTable.Api(n.settings);s=""==(s=""==(s=""==(s=""==(s="number"==typeof r.column("Ref:name").index()?a[r.column("Ref:name").index()]:"")&&"number"==typeof r.column("Reference:name").index()?a[r.column("Reference:name").index()]:s)&&"number"==typeof r.column("ref:name").index()?a[r.column("ref:name").index()]:s)&&"number"==typeof r.column("reference:name").index()?a[r.column("reference:name").index()]:s)?n.settings.sInstance+"_row_"+n.row:s,0==$("#ModalResponse"+s).length&&$("body #app-content").append('<div id="ModalResponse'+s+'" class="modal fade pagebreakafter"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><button class="close" type="button" data-dismiss="modal">&times;</button><h4 class="modal-title">Case '+s+'</h4></div><div class="modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-default print_no" onclick="print_this(\'#ModalResponse'+s+' .modal-content\')">Print</button><button class="btn btn-default" type="button" data-dismiss="modal">Close</button></div></div></div></div>'),$("#ModalResponse"+s+" .modal-body").html('<div class="htmlsummary">'+e+"</div>"),o='<button class="btn btn-info btn-sm" type="button" data-toggle="modal" data-target="#ModalResponse'+s+'"> View</button>'}return o}function render_xml(e,t,a,n){var o=e;return"display"===t&&(o="<small>"+$("<div>").text(o).html()+"</small>"),o}function render_markdown(e,t,a,n){var o=e;if("display"===t&&""!==(o=new showdown.Converter({tables:!0,strikethrough:!0}).makeHtml(o))){var s=$("<span>"+o+"</span>");$("a",s).attr("target","_blank"),o=s.html()}return o}function print_this(e){console.log(e);var t=window.open("","","left=0,top=0,width=800,height=900,toolbar=0,scrollbars=0,status=0");t.document.write('<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">'),$("head link").clone().each(function(){(this.type="text/css")&&t.document.head.appendChild(this),console.log(this)}),t.document.write($(e)[0].innerHTML),t.document.close(),t.setTimeout(function(){t.focus(),t.print(),t.close()},1e3)}function render_ref(e,t,a,n){var o=e;if("display"===t){var s=e;o='<i title="Case notes - pending" class="fas fa-comment-alt hidden case-note-pending"></i> '+e,0==$("#ModalCaseNote"+s).length&&$("body #app-content").append('<div id="ModalCaseNote'+s+'" class="modal fade"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button class="close" type="button" data-dismiss="modal">&times;</button><h4 class="modal-title">Case notes for '+s+'</h4></div><div class="modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-default print_no" onclick="print_this(\'#ModalCaseNote'+s+' .modal-content\')">Print</button><button class="btn btn-default" type="button" data-dismiss="modal">Close</button></div></div></div></div>')}return o}function render_special(e,t,a,n){if("display"==t){var o=new $.fn.dataTable.Api(n.settings),s=n.settings.aoColumns[n.col].title,r=n.settings.aoColumns[n.col].title,l=e,i="",d="";return void 0!==o.column(s+" icn:name").index()&&(l='<i style="font-size:150%" class="fas fa-'+a[o.column(s+" icn:name").index()]+'">&nbsp;</i> '+l),void 0!==o.column(s+" ttp:name").index()&&(r=a[o.column(s+" ttp:name").index()]),void 0!==o.column(s+" cls:name").index()&&(i=a[o.column(s+" cls:name").index()]),void 0!==o.column(s+" url:name").index()?""!=(d=a[o.column(s+" url:name").index()])&&(l='<a target="_parent" title="'+r+'"class="'+i+'" href="'+d+'">'+l+"</a>"):""!==i&&(l='<div title="'+r+'" class="'+i+'">'+l+"</div>"),l}return e}function loadnotes(){var e=void 0!==parent.FS&&null!==parent.FS&&null!==(ref=parent.FS.Auth)?ref.session["auth-session"]:void 0,t=$(".case-note-pending").length;return $(".case-note-pending").each(function(t){var a=$(this),n=a.parent().text().trim();if(0==$("#ModalCaseNote"+n).length&&$("body #app-content").append('<div id="ModalCaseNote'+n+'" class="modal fade"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button class="close" type="button" data-dismiss="modal">&times;</button><h4 class="modal-title">Case notes for '+n+'</h4></div><div class="modal-body"></div><div class="modal-footer"><button class="btn btn-default" type="button" data-dismiss="modal">Close</button></div></div></div></div>'),""==$("#ModalCaseNote"+n+" .modal-body").html()){var o=document.location.origin+"/api/cdb/case-notes/get?case_id="+n+"&sid="+e;a.addClass("case-note-fetching").removeClass("case-note-pending"),console.log(o),$.ajax(o).done(function(e){if(console.log(e.data.notes.length),e.data.notes.length>0){var t=$.map(e.data.notes,function(e){return'<div class="alert alert-'+(-1==e.action_required?"info":1==e.action_required?"warning":"success")+'" role="alert"><h4 class="alert-heading">'+e.user_display_name+", "+moment(e.date_created).fromNow()+"</h4>"+(0==e.action_required?"<strong>Actioned by "+e.actioned_user_display_name+" "+moment(e.actioned_date).fromNow()+"</strong><br/>":"")+(1==e.action_required?"<strong>Action Outstanding!</strong><br/>":"")+e.note+"</div>"}).reverse().join("<hr/>");$("#ModalCaseNote"+n+" .modal-body").html(t),a.parent().is(":visible")&&$("#ModalCaseNote"+n).removeClass("DO-NOT-PRINT"),console.log(e.data.notes),a.parent().empty().append('<button class="btn btn-info btn-sm" type="button" data-toggle="modal" data-target="#ModalCaseNote'+n+'">'+n+" "+e.data.notes.length.toString()+" Notes</button>")}else $("#ModalCaseNote"+n+" .modal-body").html("No notes recorded.");a.addClass("case-note-done").removeClass("case-note-fetching")})}}),t}function draw_results_table(e,t){var a,n,o=[];void 0===t.tableconfig&&(t.tableconfig="frlipBt"),void 0===t.tablebuttons&&(t.tablebuttons=["csv","colvis"]);var s,r=$("<table>");if(r.addClass("display").addClass("compact"),$("#"+t.tab+" .results").empty().append(r),$.isEmptyObject(e.transformed.rows_data))$("#"+t.tab+" .spinner").hide(),$("#"+t.tab+" .spinnermsg").html("No data").show();else{a=$.map(e.transformed.rows_data,function(e,t){return[$.map(e,function(e,t){return[e]})]}),n=$.map(e.transformed.rows_data[Object.keys(e.transformed.rows_data)[0]],function(e,t){var a=!0,n=!0,r=$.fn.dataTable.render.ellipsis(200,!0);return"response"==t.toLowerCase()&&(r=render_response,t="",n=!1),"reference"!=t.toLowerCase()&&"ref"!=t.toLowerCase()||(r=render_ref),"rowclass_hhh"==t&&(s=function(e,t,a){$(e).addClass(t[this.api().column("rowclass:name").index()])}),"_xml"==t.slice(-4)&&(t=t.slice(0,-4),r=render_xml),"_md"==t.slice(-3)&&(t=t.slice(0,-3),r=render_markdown),"_sss"==t.slice(-4)&&(t=t.slice(0,-4),r=render_special),"_url"==t.slice(-4)&&(a=!0,t=t.slice(0,-4),r=render_url,n=!1),"_nnn"==t.slice(-4)&&(t=t.slice(0,-4),o.push({column_name:t,filter_type:"range_number_slider"})),"_rrr"==t.slice(-4)&&(t=t.slice(0,-4),o.push({column_name:t,filter_type:"multi_select",select_type:"select2",case_insensitive:"true"})),"_ddd"==t.slice(-4)&&(t=t.slice(0,-4),o.push({column_name:t,filter_type:"range_date",date_format:"dd MM yyyy"})),"_dtf"==t.slice(-4)&&(t=t.slice(0,-4),o.push({column_name:t,filter_type:"range_date",date_format:"dd/mm/yyyy",moment_date_format:"DD/MM/YYYY HH:mm:ss"})),"_hhh"==t.slice(-4)&&(a=!1,t=t.slice(0,-4)),{title:t.replace(/_/g," ").trim(),name:t.replace(/_/g," ").trim(),visible:a,render:r,orderable:n,createdCell:void 0}}),console.log("cols"),console.log(n),console.log("got how many rows?"+a.length),t.counter&&$("#"+t.counter).html(a.length),$("#"+t.tab+" .spinner .msg").html("Drawing results...").show();var l=r.DataTable({dom:t.tableconfig,data:a,columns:n,scrollX:!0,buttons:t.tablebuttons,createdRow:s,configtab:t.tab,sScrollX:"100%",sScrollXInner:"100%",drawCallback:t.map?function(e){update_map(e,this.api(),t)}:null,order:t.order?t.order:[[0,"desc"]]});l.on("draw.dt",function(){$("[id^=ModalCase]").addClass("DO-NOT-PRINT"),$("[id^=ModalResponse]").addClass("DO-NOT-PRINT"),$("button[data-target]:visible").each(function(){var e=$(this).data("target");$(e).removeClass("DO-NOT-PRINT")}),loadnotes()>0&&$(this).dataTable().columns&&$(this).dataTable().columns.adjust()}),o.forEach(function(e){e.column_number=l.column(e.column_name.replace(/_/g," ")+":name").index()}),setTimeout(function(){o.length>0&&(yadcf.init(l,o,"header"),console.log("resizing"),l.columns.adjust())},2e3),$("#"+t.tab).on("click","td",function(){console.log("update map on table click");var e=$(this).closest("tr"),t=(l.row(e),Number(e.attr("class").match(/(?:row-)(\d+)/)[1])+1);console.log("centre on "+t),maplace.ViewOnMap(t)})}}function draw_results_list(e,t){var a=$("select#"+t.tab),n=$("#"+t.tab).text();a.find("option").remove().end(),$.each(e.transformed.rows_data,function(){a.append($("<option />").val(this.name).text(this.display))}),a.val(n)}function draw_results_template(e,t){var a=new showdown.Converter({tables:!0,strikethrough:!0}),n=0;for(var o in"template"===t.type&&$("#"+t.tab+" .results").children().not(".keep").empty().remove(),e.transformed.rows_data)if(e.transformed.rows_data.hasOwnProperty(o)){if(n++,"template"===t.type)var s=$("#"+t.template).clone();else s=$("body");for(var r in e.transformed.rows_data[o])if(e.transformed.rows_data.hasOwnProperty(o)){var l=e.transformed.rows_data[o][r];s.html(s.html().split("####"+r+"####").join(l)),l="_md"==r.slice(-3)?a.makeHtml(l):"_rw"==r.slice(-3)?l:escapeHtml(l),s.html(s.html().split("###"+r+"###").join(l))}if(s.html(s.html().split("###rownum###").join(n)),"template"===t.type&&(s.removeClass("oco_template").attr("id","result_"+o.split(" ").join("_")),$("#"+t.tab+" .results").append(s),$("#"+t.tab+" .results .keep").insertAfter(s)),e.transformed.rows_data[o].step_num){var i=e.transformed.rows_data[o].step_num-1;$("#"+t.tab+" .results .arrow-steps .step").slice(0,i).addClass("done"),$("#"+t.tab+" .results .arrow-steps .step:eq("+i+")").addClass("current")}}var d="";"template"===t.type?d="#"+t.tab+" .results":(d="body",void 0===t.sub&&$(".hideuntilglobal").removeClass("hideuntilglobal")),$(d+" .momentfromnow").each(function(e,t){var a=moment($(t).html(),["YYYY-MM-DD","DD/MM/YYYY HH:mm:ss"],!0);a.isValid()&&$(t).html(a.fromNow()).attr("title",a.format("LLLL")).removeClass("momentfromnow")}),$(d+" .momenttonow").each(function(e,t){var a=moment($(t).html());a.isValid()||(a=moment($(t).html(),"DD/MM/YYYY HH:mm:ss")),a.isValid()&&$(t).html(a.toNow()).attr("title",a.format("LLLL")).removeClass("momenttonow")}),$(d+" .momentlocaldatetime").each(function(e,t){var a=moment($(t).html());a.isValid()||(a=moment($(t).html(),"DD/MM/YYYY HH:mm:ss")),a.isValid()&&$(t).html(a.format("LLLL")).removeClass("momentlocaldatetime")}),$(d+" .momentlocaldate").each(function(e,t){var a=moment($(t).html());a.isValid()||(a=moment($(t).html(),"DD/MM/YYYY HH:mm:ss")),a.isValid()&&$(t).html(a.format("ddd D MMM YYYY")).removeClass("momentlocaldate")}),$(d+" .momentlocaldatenoyear").each(function(e,t){var a=moment($(t).html());a.isValid()||(a=moment($(t).html(),"DD/MM/YYYY HH:mm:ss")),a.isValid()&&$(t).html(a.format("ddd D MMM")).removeClass("momentlocaldate")}),$(d+".slickcarousel").length>0&&$(d+".slickcarousel").slick(),$(d+" .results .money").not(":contains(###)").each(function(e,t){$(t).text(Number($(t).text()).toLocaleString("en"))}).removeClass("money"),void 0===t.sub&&($(d+" .copycursor.unbound").not(":contains(###)").click(function(){copyToClipboard(this)}).removeClass("unbound"),$(d+" .hideswitch.unbound").not(":contains(###)").click(function(){hideswitch(this)}).removeClass("unbound"),$(d+" .tablefilter.unbound").not(":contains(###)").click(function(){tablefilter(this)}).removeClass("unbound"),$(d+" div.oco_country_list.unbound table td:first-child").not(":contains(###)").each(function(){$(this).addClass("flag-icon-"+$(this).html().substring(0,2)),$(this).html($(this).html().slice(2))}),$(d+" div.oco_country_list.unbound").not(":contains(###)").removeClass("unbound")),t.counter&&($("."+t.counter).each(function(){$(this).html(n)}),$("#"+t.counter).html(n))}function draw_results_plotly(e,t){var a,n,o={};switch($.extend(o,t.plotly_layout),a=e.transformed.rows_data,console.log(a),$("#"+t.tab).empty(),t.graph){case"violin":n=$.map(a,function(e){return JSON.parse(e.the_json)}),Plotly.newPlot(t.tab,n,o,{responsive:!0});break;case"stackedbar":console.log("plotly debug"),console.log(t),console.log(a),n=$.map(a,function(e){return{x:["Created","Completed","Open"],y:[e.created,e.completed,e.open],type:"bar",name:e.breakdown,wk:e.wk,barmode:"stack",marker:{color:"#FFC"}}});var s=$.map(n,function(e){return e.wk}).filter(function(e,t,a){return a.indexOf(e)===t}),r=$.map(n,function(e){return e.name}).filter(function(e,t,a){return a.indexOf(e)===t}),l=[{index:0,name:"tangelo",data:["#efa876","#ed9c62","#eb8f4f","#e9833b","#e77728","#d26d25","#be6221","#a9571e","#934c1a","#7e4116"]},{index:1,name:"light sea green",data:["#89d3d3","#76cccc","#62c4c5","#4fbdbe","#3bb6b7","#28afb0","#25a0a0","#219091","#1e8081","#1a7071"]},{index:2,name:"meat brown",data:["#f5d58e","#f3ce7b","#f1c768","#f0c055","#eeb942","#edb230","#d8a22c","#c29228","#ad8223","#97721f"]},{index:3,name:"queen blue",data:["#81aab8","#6c9cac","#578ea1","#428095","#2d7289","#19647e","#175b73","#155268","#13495c","#104051"]}];$.each(n,function(e,t){console.log(t),console.log(s.findIndex(function(e,a,n){return e==t.wk})),t.xaxis="x"+(1+s.findIndex(function(e,a,n){return e==t.wk})),t.marker.color=l[r.findIndex(function(e,a,n){return e==t.name})%4].data,t.showlegend="x1"==t.xaxis});var i=1/s.length;console.log(i),console.log(n),o.barmode="stack",$.each(s,function(e,t){o["xaxis"+(0==e?"":e+1)]={domain:[i*e,i*e+i],tickangle:-45,anchor:"x"+(e+1),title:t}}),console.log("my layout is"),console.log(o),Plotly.newPlot(t.tab,n,o,{responsive:!0});break;case"debug":console.log("plotly debug"),console.log(t),console.log(a);break;case"generic":var d=t.plotly_tracedata?t.plotly_tracedata:{type:"bar"},c=$.map(a,function(e){return e[Object.keys(e)[2]]}).filter(function(e,t,a){return a.indexOf(e)===t});n=$.map(c,function(e){return $.extend({x:[],y:[],name:e},d)}),$.map(a,function(e){n[c.indexOf(e[Object.keys(e)[2]])].x.push(e[Object.keys(e)[0]]),n[c.indexOf(e[Object.keys(e)[2]])].y.push(e[Object.keys(e)[1]])}),Plotly.newPlot(t.tab,n,o,{responsive:!0});break;case"pie":d=t.plotly_tracedata?t.plotly_tracedata:{type:"pie"};n=[$.extend({values:$.map(a,function(e){return e.y}),labels:$.map(a,function(e){return e.series})},d)],Plotly.newPlot(t.tab,n,o,{responsive:!0});break;case"bar":var m={x:$.map(a,function(e){return e.wk}),y:$.map(a,function(e){return e.created}),name:"Created",type:"bar"},u={x:$.map(a,function(e){return e.wk}),y:$.map(a,function(e){return e.completed}),name:"Completed",type:"bar"},p={x:$.map(a,function(e){return e.wk}),y:$.map(a,function(e){return e.open}),name:"Open",type:"bar"};n=[m,u,p],Plotly.newPlot(t.tab,n,o,{responsive:!0});break;case"line":var f=[{type:"scatter",mode:"lines",name:"Total submissions",x:unpack(a,"date"),y:unpack(a,"daily_submissions")},{type:"scatter",mode:"lines",name:"Dash submissions",x:unpack(a,"date"),y:unpack(a,"dash_submissions")},{type:"scatter",mode:"lines",name:"Self submissions",x:unpack(a,"date"),y:unpack(a,"self_submissions")},{type:"scatter",mode:"lines",name:"Service submissions",x:unpack(a,"date"),y:unpack(a,"service_submissions")},{type:"scatter",mode:"lines",name:"Forms submissions",x:unpack(a,"date"),y:unpack(a,"forms_submissions")}];o={title:"Completed cases volume trend",xaxis:{autorange:!0,range:[$("#daterangestart").html(),$("#daterangeend").html()],rangeselector:{buttons:[{count:1,label:"1w",step:"week",stepmode:"backward"},{count:1,label:"1m",step:"month",stepmode:"backward"},{count:6,label:"6m",step:"month",stepmode:"backward"},{step:"all"}]},rangeslider:{range:[$("#daterangestart").html().substring(6,10)+"-"+$("#daterangestart").html().substring(3,5)+"-"+$("#daterangestart").html().substring(0,2),$("#daterangeend").html().substring(6,10)+"-"+$("#daterangeend").html().substring(3,5)+"-"+$("#daterangeend").html().substring(0,2)]},type:"date"},yaxis:{autorange:!0,type:"linear"}},Plotly.newPlot(t.tab,f,o,{responsive:!0});break;default:$("#"+t.tab+" .spinnermsg").html("Invalid plotly graph type: "+t.graph).show()}}function update_map(e,t,a){console.log("update map");var n=t.column("view:name").index(),o=t.column("maplocation:name").index(),s=t.column("mapicon:name").index();if(void 0!==o){var r={locations:[]};$("#"+a.map).show();var l=[];t.columns().every(function(){l.push($(this.header()).children(".DataTables_sort_wrapper").text())}),t.rows({page:"all",search:"applied"}).every(function(e,t,i){var d=this.data();if(2==d[o].split(", ").length&&"0, 0"!=d[o]&&", "!=d[o]){var c={lat:d[o].split(", ")[0],lon:d[o].split(", ")[1],html:'<a target="_parent" href="'+d[n]+'">'+d[0]+"</a>",icon:void 0!==s?d[s]:""};a.maptemplate?(c.html=$("#"+a.maptemplate).html(),l.forEach(function(e,t){c.html=c.html.split("###"+e+"###").join(d[t])})):l.forEach(function(e,t){c.html=c.html+"<br/><b>"+e+"</b>: "+d[t]}),r.locations.push(c);var m=this.node();$(m).removeClass(function(e,t){return(t.match(/\brow-\d+/g)||[]).join(" ")}),$(m).addClass("row-"+i)}}),maplace.Loaded?maplace.SetLocations(r.locations,!0):maplace.Load({locations:r.locations})}else $("#"+a.map).hide()}function draw_results(e,t){if($("#"+t.tab+" .spinner .msg").html("Processing results...").show(),$("#"+t.tab+" .results").children().not(".keep").empty().remove(),t.map&&void 0===maplace&&(maplace=new Maplace({shared:{zoom:16},directions_options:{travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.METRIC,optimizeWaypoints:!1,provideRouteAlternatives:!1,avoidHighways:!1,avoidTolls:!1},map_options:{set_center:t.map.center,zoom:t.map.zoom}}).Load()),$.isEmptyObject(e.transformed.rows_data))$("#"+t.tab+" .spinnermsg").html("No data").show(),t.nodata&&$("#"+t.nodata).show().removeClass("hidden");else{switch(t.nodata&&$("#"+t.nodata).hide().addClass("hidden"),t.type){case"global":draw_results_template(e,t);break;case"table":draw_results_table(e,t);break;case"template":draw_results_template(e,t);break;case"selectlist":draw_results_list(e,t);break;case"plotly":draw_results_plotly(e,t);break;default:$("#"+t.tab+" .spinnermsg").html("Invalid configuration template - "+t.type).show()}if("object"==typeof t.sub)for(var a=0;a<t.sub.length;a++)for(var n=0;n<e.transformed.select_data.length;n++)get_data(t.sub[a],e.transformed.rows_data[n])}$("#"+t.tab+" .spinner").hide()}function log_error(e,t){$("#spinnermsg").html("Error attempting "+e+" : "+t).show()}function run_lookup(e,t,a,n){var o,s,r;if(void 0===parent.FS)return alert("Unable to find AchieveForms session id");if(r=void 0!==parent.FS&&null!==parent.FS&&null!==(s=parent.FS.Auth)?s.session["auth-session"]:void 0){o={stopOnFailure:!0,usePHPIntegrations:!0,user:{},formId:"",formValues:{"Section 1":{}},isPublished:!1,formName:"",tokens:{port:"",host:"",site_url:"",site_path:"",site_origin:"",user_agent:"",site_protocol:"",session_id:"",product:"",formLanguage:"",authenticationType:"",isAuthenticated:!0,api_url:"",transactionReference:"",transaction_status:"",published:!1,timeZone:""},env_tokens:{weburl:""},site:"",created:"",reference:"",formUri:""},$.extend(o.tokens,t);var l={};return $.each(t,function(e,t){l[e]={name:e,value:t}}),$.extend(o.formValues["Section 1"],l),$.ajax({type:"POST",contentType:"application/json",url:"/apibroker/runLookup?app_name=AchieveForms&sid="+r+"&id="+e,data:JSON.stringify(o),success:function(e){var t;return t=e.integration,console.log(t),t&&t.transformed?a(t):n()},error:function(e){return console.log(e),n()}})}alert("Unable to find AchieveForms session id")}$(document).ready(function(){if(""!==$("#pagetitle").text()&&(window.parent.document.title=$("#pagetitle").text()),void 0!==parent.FS){var e=$('script[src$="oco.js"]').attr("src").replace("oco.js","");$.ajaxSetup({cache:!0}),$.when($.getScript(e+"moment/moment.min.js"),$.getScript(e+"datatables/datatables.min.js"),$.getScript(e+"showdown/showdown.min.js"),$.getScript(e+"plotly/plotly-latest.min.js"),$.getScript(e+"maplace/maplace.min.js"),$.Deferred(function(e){$(e.resolve)})).done(function(){$.when($.getScript(e+"daterangepicker/daterangepicker.js"),$.getScript(e+"datatables/datetime-moment.js"),$.getScript(e+"datatables/select2.min.js"),$.getScript(e+"datatables/ellipsis.js"),$.getScript(e+"datatables/jquery.dataTables.yadcf.js"),$.Deferred(function(e){$(e.resolve)})).done(function(){$.fn.dataTable.moment("DD/MM/YYYY"),$.fn.dataTable.moment("YYYY-MM-DD"),$.fn.dataTable.moment("DD MMM YYYY"),$.fn.dataTable.moment("DD/MM/YYYY HH:mm:ss"),"undefined"==typeof Plotly&&$("#plotly").length>0&&$.getScript("/plotly/plotly-finance-latest.js",function(){console.log("loaded plotly"),$.getScript("/plotly/plotly-cartesian-latest.js",function(){console.log("loaded plotly cartesian"),window.onresize=function(){Plotly.Plots.resize("plotly_box"),Plotly.Plots.resize("plotly_violin")}})}),$("#daterangestart").html(moment().subtract(30,"days").format("YYYY-MM-DD")),$("#daterangeend").html(moment().format("YYYY-MM-DD")),$('input[name="daterange"]').val(moment().subtract(30,"days").format("DD MMM YYYY HH:mm")+" - "+moment().format("DD MMM YYYY HH:mm")),$('input[name="daterange"]').daterangepicker({timePicker:!0,timePicker24Hour:!0,timePickerIncrement:1,locale:{format:"DD MMM YYYY HH:mm",cancelLabel:"Clear (Show open cases)"},showCustomRangeLabel:!0,ranges:{"Last 24h":[moment().subtract(1,"days").format("DD MMM YYYY HH:mm"),moment().format("DD MMM YYYY HH:mm")],"Last 7 days":[moment().subtract(7,"days").format("DD MMM YYYY HH:mm"),moment().format("DD MMM YYYY HH:mm")],"Last 30 days":[moment().subtract(30,"days").format("DD MMM YYYY HH:mm"),moment().format("DD MMM YYYY HH:mm")],"Last month":[moment().subtract(moment().date()-1,"days").subtract(1,"month").format("DD MMM YYYY 00:00"),moment().subtract(moment().date()-1,"days").format("DD MMM YYYY 00:00")],"Last quarter":[moment().startOf("quarter").subtract(3,"month").format("DD MMM YYYY 00:00"),moment().startOf("quarter").format("DD MMM YYYY 00:00")]}},pickdate),$('input[name="daterange"]').on("cancel.daterangepicker",function(e,t){$(this).val(""),$("#daterangestart").html(""),$("#daterangeend").html(""),refreshLookups()}),$("body").on("change",".selectpicker",function(){picklist(this)}),setTimeout(function(){console.log("binding"),console.log($("#printhelp div.newprintmode")),$(".print.unbound").on("click",function(){window.print()}).removeClass("unbound"),$("#printhelp div.newprintmode").on("click",function(){togglePrint()}).removeClass("newprintmode").addClass("printmode"),$(".newselectpicker").removeClass("newselectpicker").addClass("selectpicker")},3e3),refreshLookups(),$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){$(e.target.hash+" .js-plotly-plot").each(function(){console.log(this.id),Plotly.relayout(this.id,{})})})})}),$.ajaxSetup({cache:!1})}else $("#console").append("Unable to find AchieveForms session id<br/>")});var tablepages={};function togglePrint(){if(0==$(".oco_pagebuilder.printready").length){$("#printhelp div.printmode").addClass("on");for(var e=0;e<document.styleSheets.length;e++){var t=document.styleSheets[e];if(t.href&&t.href.indexOf("bootstrap")>0)for(var a=0;a<t.rules.length;a++){var n=t.rules[a];if(n.conditionText&&"print"==n.conditionText)for(var o=0;o<n.cssRules.length;o++){"*"==n.cssRules[o].selectorText&&n.deleteRule(o)}}}$.fn.dataTable.tables().forEach(function(e){var t=$("#"+e.id).DataTable();void 0!==t.page.info()&&(tablepages[e.id]=t.page.info().length,t.page.len(5e3).draw())}),$(parent.document).find("#toolbar").hide(),$(parent.document).find("#header").hide(),$(parent.document).find("#navigation").hide(),$(parent.document).find(".footer").hide(),$(".oco_pagebuilder").addClass("printready"),$(".tab-content").removeClass("col-md-10").addClass("col-md-12")}else $("#printhelp div.printmode").removeClass("on"),$.fn.dataTable.tables().forEach(function(e){var t=$("#"+e.id).DataTable();void 0!==t.page.info()&&t.page.len(tablepages[e.id]).draw()}),$(parent.document).find("#toolbar").show(),$(parent.document).find("#header").show(),$(parent.document).find("#navigation").show(),$(parent.document).find(".footer").show(),$(".oco_pagebuilder").removeClass("printready"),$(".tab-content").removeClass("col-md-12").addClass("col-md-10")}$.fn.rotate=function(e){var t,a,n=$(this),o=0;function s(e){var a=!1,n=document.createElement("div").style;return $.each(t,function(t,o){""===n[o.replace(/\-/g,"")+e]&&(a=!0)}),a}function r(e,a){var n={};return s.transform?($.each(t,function(t,o){n[o.toLowerCase()+e]=a||""}),n):n}return t=["-Webkit-","-Moz-","-O-","-ms-",""],a=$.extend({startDeg:!1,endDeg:360,duration:1,count:1,easing:"linear",animate:{},forceJS:!1},e),s.transform=s("Transform"),s.transition=s("Transition"),a.endDeg*=a.count,a.duration*=a.count,s.transition&&!a.forceJS?(/Firefox/.test(navigator.userAgent)&&(o=e&&e.animate||!(!1===a.startDeg||a.startDeg>=0)?25:0),n.queue(function(e){!1!==a.startDeg&&n.css(r("transform","rotate("+a.startDeg+"deg)")),setTimeout(function(){n.css(r("transition","all "+a.duration+"s "+a.easing)).css(r("transform","rotate("+a.endDeg+"deg)")).css(a.animate)},o),setTimeout(function(){n.css(r("transition")),a.persist||n.css(r("transform")),e()},1e3*a.duration-o)})):(!1===a.startDeg&&(a.startDeg=n.data("rotated")||0),a.animate.perc=100,n.animate(a.animate,{duration:1e3*a.duration,easing:$.easing[a.easing]?a.easing:"",step:function(e,t){var o;"perc"===t.prop&&(o=a.startDeg+(a.endDeg-a.startDeg)*e/100,n.css(r("transform","rotate("+o+"deg)")).css("filter",function(e){var t,a,n;return s.transform?"":(t=e>=0?Math.PI*e/180:Math.PI*(360+e)/180,"progid:DXImageTransform.Microsoft.Matrix(M11="+(a=Math.cos(t))+",M12="+-(n=Math.sin(t))+",M21="+n+",M22="+a+',SizingMethod="auto expand")')}(o)))},complete:function(){if(a.persist)for(;a.endDeg>=360;)a.endDeg-=360;else a.endDeg=0,n.css(r("transform"));n.css("perc",0).data("rotated",a.endDeg)}})),n};