var maplace;function maplaceHiglightRow(e,t,n){$("#"+n.tableID+" .results tr").removeClass("mapclicked"),$("#"+n.tableID+" .results tr.row-"+n.rowID).addClass("mapclicked")}function load_a_script(e){if(e.length>0){var t=e.pop();console.log("Loading: "+t),$.getScript(t,function(){console.log("Loaded: "+t),e.length>0?load_a_script(e):start()})}}function start(){if(sid=void 0!==parent.FS&&null!==parent.FS&&null!==(ref=parent.FS.Auth)?ref.session["auth-session"]:void 0,void 0!==parent.FS.Auth.session.user||0!=$("#ucrn.config").length&&""==$("#ucrn.config").html().replace(/&nbsp;$/,"")){var e=JSON.parse($("#lookup_config").text()),t=e.map(e=>e.type);console.log("all scripts loaded."),t.includes("table")&&($.fn.dataTable.moment("DD/MM/YYYY"),$.fn.dataTable.moment("YYYY-MM-DD"),$.fn.dataTable.moment("DD MMM YYYY"),$.fn.dataTable.moment("DD/MM/YYYY HH:mm:ss")),console.log("starting up. cookie:");for(var n=decodeURIComponent(document.cookie).split(";"),a=0;a<n.length;a++){var o=n[a].split("=");$("#"+o[0].trim()+".config").html(o[1])}moment($("#daterangestart").html(),"YYYY-MM-DD HH:mm",!0).isValid()||($("#daterangestart").html(moment().subtract(30,"days").format("YYYY-MM-DD 00:00")),$("#daterangeend").html(moment().format("YYYY-MM-DD 00:00"))),$('input[name="daterange"]').val(moment($("#daterangestart").html()).format("DD MMM YYYY HH:mm")+" - "+moment($("#daterangeend").html()).format("DD MMM YYYY HH:mm")),$('input[name="daterange"]').daterangepicker({timePicker:!0,timePicker24Hour:!0,timePickerIncrement:1,locale:{format:"DD MMM YYYY HH:mm",cancelLabel:"Clear (Show open cases)"},showCustomRangeLabel:!0,ranges:{"Next 7 days":[moment().format("DD MMM YYYY 00:00"),moment().add(7,"days").format("DD MMM YYYY 00:00")],"Next 24h":[moment().format("DD MMM YYYY HH:mm"),moment().add(1,"days").format("DD MMM YYYY HH:mm")],"Last 24h":[moment().subtract(1,"days").format("DD MMM YYYY HH:mm"),moment().format("DD MMM YYYY HH:mm")],"Last 7 days":[moment().subtract(7,"days").format("DD MMM YYYY 00:00"),moment().format("DD MMM YYYY 00:00")],"Last 30 days":[moment().subtract(30,"days").format("DD MMM YYYY 00:00"),moment().format("DD MMM YYYY 00:00")],"Last month":[moment().subtract(moment().date()-1,"days").subtract(1,"month").format("DD MMM YYYY 00:00"),moment().subtract(moment().date()-1,"days").format("DD MMM YYYY 00:00")],"Last quarter":[moment().startOf("quarter").subtract(3,"month").format("DD MMM YYYY 00:00"),moment().startOf("quarter").format("DD MMM YYYY 00:00")]}},pickdate),$('input[name="daterange"]').on("cancel.daterangepicker",function(e,t){$(this).val(""),$("#daterangestart").html(""),$("#daterangeend").html(""),refreshLookups()}),$("body").on("change",".selectpicker",function(){picklist(this)}),$("body").on("click","a.buttonpusher.selectall",function(){allbuttonpush(this,!0)}),$("body").on("click","a.buttonpusher.clearall",function(){allbuttonpush(this,!1)}),$("body").on("click","input.acscriteria",function(){var e=$(this).attr("data-acsconfig");$("#"+e+".config").html($(this).prop("checked").toString()),refreshLookups()}),setTimeout(function(){console.log("binding"),console.log($("#printhelp div.newprintmode")),$(".print.unbound").on("click",function(){window.print()}).removeClass("unbound"),$("#printhelp div.newprintmode").on("click",function(){togglePrint()}).removeClass("newprintmode").addClass("printmode"),$(".newselectpicker").removeClass("newselectpicker").addClass("selectpicker")},3e3);for(a=0;a<e.length;a++)(e[a].type="calendar")&&setupCalendar(e[a]);refreshLookups(),$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){$(e.target.hash+" .js-plotly-plot").each(function(){console.log(this.id),Plotly.relayout(this.id,{})})})}else parent.location.reload()}function traverse(e,t){for(var n in e)null!==e[n]&&"object"==typeof e[n]&&traverse(e[n],t),e[n]=t.apply(this,[n,e[n]])}function StringToBool(e,t){return["true","false"].includes(t.toString().toLowerCase())?"true"===t.toString().toLowerCase():t}function check_calendar_save(e,t,n){console.log("checking save response..."),console.log(e);var a=e.transformed.error?e.transformed.error:"";""==a&&e.transformed.rows_data[0]&&e.transformed.rows_data[0].error&&(a=e.transformed.rows_data[0].error),a?(t(e),alert(a)):n&&n(e)}function setupCalendar(e){var t=$("#"+e.tab+" .fullcalendar")[0];$("#"+e.tab+" .trashcan")[0];if(traverse(e,StringToBool),void 0!==t){var n=e.fullcalendar;if(void 0!==e.lookup_event&&(n.events=function(t,n,a){run_lookup(e.lookup_event,get_config(t),function(e){traverse(e.transformed.rows_data,StringToBool),n(Object.values(e.transformed.rows_data))},a)}),void 0!==e.lookup_resources&&(n.resources=function(t,n,a){run_lookup(e.lookup_resources,get_config(t),function(e){n(Object.values(e.transformed.rows_data))},a)}),void 0!==e.lookup_eventchange&&(n.eventDrop=function(t){console.log("saving eventDrop or eventResize change"),$(t.event._context.calendarApi.el).parent().find(".status").html("Saving...");var n={eventID:t.event.id,start:t.event.start,end:t.event.end,oldResource:t.oldResource?t.oldResource.id:null,newResource:t.newResource?t.newResource.id:null};$.extend(n,t.event.extendedProps),""==n.eventID&&(n.eventID=n.sql_id),run_lookup(e.lookup_eventchange,get_config(n),function(e){check_calendar_save(e,function(){t.revert()}),$(t.event._context.calendarApi.el).parent().find(".status").html("Ready")},function(){t.revert()})},n.eventResize=n.eventDrop),($("#"+e.tab+" .trashcan").length=e.lookup_eventdelete)&&(n.eventDragStop=function(t){var n=$("#"+e.tab+" .trashcan"),a=n.offset(),o=a.left,s=a.left+n.outerWidth(!0),r=a.top,l=a.top+n.outerHeight(!0);if(t.jsEvent.pageX>=o&&t.jsEvent.pageX<=s&&t.jsEvent.pageY>=r&&t.jsEvent.pageY<=l){var i={eventID:t.event.id,start:t.event.start,end:t.event.end};$.extend(i,t.event.extendedProps),""==i.eventID&&(i.eventID=i.sql_id),$(t.event._context.calendarApi.el).parent().find(".status").html("Deleting..."),run_lookup(e.lookup_eventdelete,get_config(i),function(e){check_calendar_save(e,function(){return 0},function(e){t.event.remove(),$(t.event._context.calendarApi.el).parent().find(".status").html("Ready")})},function(){return 0})}}),n.droppable)n.eventReceive=function(t){var n={eventID:t.event.id,start:t.event.start,end:t.event.end,title:t.event.title};$.extend(n,t.event.extendedProps);var a=[];void 0!==t.event._def.resourceIds&&(a=t.event.getResources()),n.resourceId=a.length>0?a[0].id:"",run_lookup(e.lookup_eventreceive,get_config(n),function(e){check_calendar_save(e,function(){t.event.remove()},function(e){t.event._context.calendarApi.refetchEvents(),t.event.remove()})},function(){t.event.remove()})},new(0,FullCalendar.Draggable)(document.getElementById("external-events"),{itemSelector:".fc-event",eventData:function(e){return e.getAttribute("data-event")?JSON.parse(e.getAttribute("data-event")):{title:e.innerText.trim()}}});e.modal_response&&(n.eventClick=function(e){console.log("modal time for event"),console.log(e.event.extendedProps.response),0==$("#ModalResponse"+e.event.extendedProps.reference).length&&$("body #app-content").append('<div id="ModalResponse'+e.event.extendedProps.reference+'" class="modal fade pagebreakafter"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><button class="close" type="button" data-dismiss="modal">&times;</button><h4 class="modal-title">Case '+e.event.extendedProps.reference+'</h4></div><div class="modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-default print_no" onclick="print_this(\'#ModalResponse'+e.event.extendedProps.reference+' .modal-content\')">Print</button><button class="btn btn-default" type="button" data-dismiss="modal">Close</button></div></div></div></div>'),$("#ModalResponse"+e.event.extendedProps.reference+" .modal-body").html('<div class="htmlsummary">'+e.event.extendedProps.response+"</div>"),$("#ModalResponse"+e.event.extendedProps.reference).modal("show")}),n.plugins=[],void 0===n.initialView&&(n.initialView=n.defaultView),new FullCalendar.Calendar(t,n).render(),$("#"+e.tab+" .spinner").hide()}}function oldstuff(){$.when($.getScript(jsfolder+"moment/moment.min.js"),$.Deferred(function(e){$(e.resolve)})).done(function(){$.when(console.log("done loading scripts"),$.getScript(jsfolder+"daterangepicker/daterangepicker.js"),$.getScript(jsfolder+"datatables/datetime-moment.js"),$.getScript(jsfolder+"datatables/select2.min.js"),$.getScript(jsfolder+"datatables/ellipsis.js"),$.getScript(jsfolder+"datatables/jquery.dataTables.yadcf.js"),$.Deferred(function(e){$(e.resolve)})).done(function(){$.fn.dataTable.moment("DD/MM/YYYY"),$.fn.dataTable.moment("YYYY-MM-DD"),$.fn.dataTable.moment("DD MMM YYYY"),$.fn.dataTable.moment("DD/MM/YYYY HH:mm:ss"),"undefined"==typeof Plotly&&$("#plotly").length>0&&$.getScript("/plotly/plotly-finance-latest.js",function(){console.log("loaded plotly"),$.getScript("/plotly/plotly-cartesian-latest.js",function(){console.log("loaded plotly cartesian"),window.onresize=function(){Plotly.Plots.resize("plotly_box"),Plotly.Plots.resize("plotly_violin")}})})})}),$.ajaxSetup({cache:!1})}function refreshLookups(){$(".modal").remove(),$(".nodatamsg").hide();for(var e=JSON.parse($("#lookup_config").text()),t=0;t<e.length;t++)"calendar"==e[t].type||get_data(e[t])}function buttonpush(e){if(e.getAttribute("config")){var t=$("#"+e.getAttribute("config")+".config"),n=t.html().split(",");$(e).hasClass("active")?(n.splice(n.indexOf(e.value),1),$(e).parent().find(".selectall").removeClass("active")):n.push(e.value),t.html(n.toString()),document.cookie=e.getAttribute("config")+"="+n.toString()+";path="+document.location.pathname}}function allbuttonpush(e,t){t?($(e).addClass("active"),$(e).parent().find("a:not(.active,.clearall,.selectall)").each(function(){buttonpush(this)}).addClass("active")):($(e).removeClass("active"),$(e).parent().find("a.active:not(.clearall,.selectall)").each(function(){buttonpush(this)}).removeClass("active")),refreshLookups()}function picklist(e){$("#"+e.id+".config").html(e.value),document.cookie=e.id+"="+e.value+";path="+document.location.pathname,refreshLookups()}function pickdate(e,t,n){$("#daterangestart").html(e.format("YYYY-MM-DD HH:mm")),$("#daterangeend").html(t.format("YYYY-MM-DD HH:mm")),document.cookie="daterangestart="+e.format("YYYY-MM-DD HH:mm")+";path="+document.location.pathname,document.cookie="daterangeend="+t.format("YYYY-MM-DD  HH:mm")+";path="+document.location.pathname,refreshLookups()}function hideswitch(e){$(e).hasClass("on")?($("."+$(e).attr("id")).hide(500),$(e).removeClass("on")):($("."+$(e).attr("id")).show(500),$(e).addClass("on"))}function tablefilter(e){console.log(e),console.log($(e).attr("data-tableid")),console.log($(e).attr("data-tablefilter")),$("#"+$(e).attr("data-tableid")+" .results th select").val($(e).attr("data-tablefilter")).trigger("change")}function copyToClipboard(e){var t=$("<input>");$("body").append(t),t.val($(e).text().trim()).select(),console.log("copying "+$(e).text().trim()),document.execCommand("copy"),t.remove()}function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function escapeRegExp(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function unpack(e,t){return $.map(e,function(e){return e[t]})}function get_config(e){var t={};if(sid=void 0!==parent.FS&&null!==parent.FS&&null!==(ref=parent.FS.Auth)?ref.session["auth-session"]:void 0,void 0!==parent.FS.Auth.session.user||0!=$("#ucrn.config").length&&""==$("#ucrn.config").html().replace(/&nbsp;$/,"")){var n="undefined"!=typeof sid&&void 0!==parent.FS.Auth.session.user&&null!==parent.FS.Auth.session.user?parent.FS.Auth.session.user.email:"",a="undefined"!=typeof sid&&void 0!==parent.FS.Auth.session.user&&null!==parent.FS.Auth.session.user?parent.FS.Auth.session.user.attributes.ucrn:"";return"object"==typeof e&&(t=e),$(".config").map(function(){"lookup_config"!=this.id&&(t[this.id]=$(this).html().replace(/&nbsp;$/,""))}),t.Email_Address=n,t.user_email=n,t.ucrn=a,t}parent.location.reload()}function get_data(e,t){$("."+e.tab+".refreshbutton.unbound").on("click",function(){get_data(e),$("i",this).rotate({count:4,duration:.6,easing:"ease-out"})}).removeClass("unbound");var n=$("#"+e.table).html();void 0===n&&(n="");var a=get_config(t);$("#"+e.tab+" .spinner").show(),$("#"+e.tab+" .spinner .msg").html("Getting data...").show(),run_lookup(e.lookup,a,function(t){draw_results(t,e)},function(t){log_error(e.tab,t)})}function render_url(e,t,n,a){var o=a.settings.aoColumns[a.col].title,s="",r="_parent";return"view"==o.toLowerCase()&&(o='<i class="fas fa-eye"></i>',o='<button type="button" class="btn btn-info btn-sm"><i class="fas fa-eye"> </i>  View</button>',s="font-size:150%"),"edit"==o.toLowerCase()&&("EDIT"==o&&(r="_BLANK"),o='<button type="button" class="btn btn-success btn-sm"><i class="far fa-file-alt"> </i> Edit</button>',s="font-size:150%"),"new"==o.toLowerCase()&&(o='<button type="button" class="btn btn-success btn-sm"><i class="fas fa-plus-square"></i> New</button>',s="font-size:150%",r="_BLANK"),"display"!==t||0!==e&&""!==e&&null!==e?'<a title="'+a.settings.aoColumns[a.col].title+'"style="'+s+'" target="'+r+'" href="'+e+'">'+o+"</a>":e}function render_response(e,t,n,a){var o=e;if("display"===t){var s,r,l=new $.fn.dataTable.Api(a.settings);if(s=""==(s=""==(s=""==(s=""==(s="number"==typeof l.column("Ref:name").index()?n[l.column("Ref:name").index()]:"")&&"number"==typeof l.column("Reference:name").index()?n[l.column("Reference:name").index()]:s)&&"number"==typeof l.column("ref:name").index()?n[l.column("ref:name").index()]:s)&&"number"==typeof l.column("reference:name").index()?n[l.column("reference:name").index()]:s)?a.settings.sInstance+"_row_"+a.row:s,0==$("#ModalResponse"+s).length)r=(r='<div id="ModalResponse###ref###" class="modal fade pagebreakafter"><div class="modal-dialog modal-lg"><div class="modal-content">'+(r=a.settings.oInit.popupTemplateID&&a.settings.oInit.popupLookup?($(".spinner").length>0?$(".spinner")[0].outerHTML:"")+'<div class="results"></div>':a.settings.oInit.popupTemplateID?$("#"+a.settings.oInit.popupTemplateID).html():'<div class="modal-header"><button class="close" type="button" data-dismiss="modal">&times;</button><h4 class="modal-title">Case ###ref###</h4></div><div class="modal-body"><div class="htmlsummary">###data###</div></div>')+'<div class="modal-footer"><button type="button" class="btn btn-default print_no" onclick="print_this(\'#ModalResponse###ref### .modal-content\')">Print</button><button class="btn btn-default" type="button" data-dismiss="modal">Close</button></div></div></div></div>').replaceAll("###ref###",s).replaceAll("###data###",e),$("body #app-content").append(r);o=a.settings.oInit.popupLookup?"onclick=\"popupAjax('ModalResponse"+s.replaceAll("'","\\'")+"','"+e.replaceAll("'","\\'")+"','"+a.settings.oInit.popupLookup+"','"+a.settings.oInit.popupTemplateID+"')\" ":"",o='<button class="btn btn-info btn-sm" type="button" data-toggle="modal" data-target="#ModalResponse'+s+'" '+o+' ><i class="fab fa-readme"> </i> Read</button>'}return o}function popupAjax(e,t,n,a){console.log("populateAjax called with id "+e+", ref "+t+" and lookup "+n),get_data({type:"template",lookup:n,tab:e,template:a},{id:e,ref:t})}function render_xml(e,t,n,a){var o=e;return"display"===t&&(o="<small>"+$("<div>").text(o).html()+"</small>"),o}function render_markdown(e,t,n,a){var o=e;if("display"===t&&""!==(o=new showdown.Converter({tables:!0,strikethrough:!0}).makeHtml(o))){var s=$("<span>"+o+"</span>");$("a:not(target)",s).attr("target","_blank"),o=s.html()}return o}function print_this(e){console.log(e);var t=window.open("","","left=0,top=0,width=800,height=900,toolbar=0,scrollbars=0,status=0");t.document.write('<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">'),$("head link").clone().each(function(){(this.type="text/css")&&t.document.head.appendChild(this),console.log(this)}),t.document.write($(e)[0].innerHTML),t.document.close(),t.setTimeout(function(){t.focus(),t.print(),t.close()},1e3)}function render_ref(e,t,n,a){var o=e;if("display"===t){var s=e;o='<i title="Case notes - pending" class="fas fa-comment-alt hidden case-note-pending"></i> '+e,0==$("#ModalCaseNote"+s).length&&$("body #app-content").append('<div id="ModalCaseNote'+s+'" class="modal fade"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button class="close" type="button" data-dismiss="modal">&times;</button><h4 class="modal-title">Case notes for '+s+'</h4></div><div class="modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-default print_no" onclick="print_this(\'#ModalCaseNote'+s+' .modal-content\')">Print</button><button class="btn btn-default" type="button" data-dismiss="modal">Close</button></div></div></div></div>')}return o}function render_special(e,t,n,a){if("display"==t){var o=new $.fn.dataTable.Api(a.settings),s=a.settings.aoColumns[a.col].title,r=a.settings.aoColumns[a.col].title,l=e,i="",d="";return void 0!==o.column(s+" icn:name").index()&&(l='<i style="font-size:150%" class="fas fa-'+n[o.column(s+" icn:name").index()]+'">&nbsp;</i> '+l),void 0!==o.column(s+" ttp:name").index()&&(r=n[o.column(s+" ttp:name").index()]),void 0!==o.column(s+" cls:name").index()&&(i=n[o.column(s+" cls:name").index()]),void 0!==o.column(s+" url:name").index()?""!=(d=n[o.column(s+" url:name").index()])&&(l='<a target="_parent" title="'+r+'"class="'+i+'" href="'+d+'">'+l+"</a>"):""!==i&&(l='<div title="'+r+'" class="'+i+'">'+l+"</div>"),l}return e}function loadnotes(){var e=void 0!==parent.FS&&null!==parent.FS&&null!==(ref=parent.FS.Auth)?ref.session["auth-session"]:void 0,t=$(".case-note-pending").length;return $(".case-note-pending").each(function(t){var n=$(this),a=n.parent().text().trim();if(0==$("#ModalCaseNote"+a).length&&$("body #app-content").append('<div id="ModalCaseNote'+a+'" class="modal fade"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button class="close" type="button" data-dismiss="modal">&times;</button><h4 class="modal-title">Case notes for '+a+'</h4></div><div class="modal-body"></div><div class="modal-footer"><button class="btn btn-default" type="button" data-dismiss="modal">Close</button></div></div></div></div>'),""==$("#ModalCaseNote"+a+" .modal-body").html()){var o=document.location.origin+"/api/cdb/case-notes/get?case_id="+a+"&sid="+e;n.addClass("case-note-fetching").removeClass("case-note-pending"),console.log(o),$.ajax(o).done(function(e){if(console.log(e.data.notes.length),e.data.notes.length>0){var t=$.map(e.data.notes,function(e){return'<div class="alert alert-'+(-1==e.action_required?"info":1==e.action_required?"warning":"success")+'" role="alert"><h4 class="alert-heading">'+e.user_display_name+", "+moment(e.date_created).fromNow()+"</h4>"+(0==e.action_required?"<strong>Actioned by "+e.actioned_user_display_name+" "+moment(e.actioned_date).fromNow()+"</strong><br/>":"")+(1==e.action_required?"<strong>Action Outstanding!</strong><br/>":"")+e.note+"</div>"}).reverse().join("<hr/>");$("#ModalCaseNote"+a+" .modal-body").html(t),n.parent().is(":visible")&&$("#ModalCaseNote"+a).removeClass("DO-NOT-PRINT"),console.log(e.data.notes),n.parent().empty().append('<button class="btn btn-info btn-sm" type="button" data-toggle="modal" data-target="#ModalCaseNote'+a+'">'+a+" "+e.data.notes.length.toString()+" Notes</button>")}else $("#ModalCaseNote"+a+" .modal-body").html("No notes recorded.");n.addClass("case-note-done").removeClass("case-note-fetching")})}}),t}function draw_results_table(e,t){var n,a,o=[];void 0===t.tableconfig&&(t.tableconfig="frlipBt"),void 0===t.tablebuttons&&(t.tablebuttons=["csv","colvis"]);var s,r=$("<table>");if(r.addClass("display").addClass("compact"),$("#"+t.tab+" .results").empty().append(r),$.isEmptyObject(e.transformed.rows_data))$("#"+t.tab+" .spinner").hide();else{n=$.map(e.transformed.rows_data,function(e,t){return[$.map(e,function(e,t){return[e]})]}),a=$.map(e.transformed.rows_data[Object.keys(e.transformed.rows_data)[0]],function(e,t){var n=!0,a=!0,r=$.fn.dataTable.render.ellipsis(200,!0);return"response"==t.toLowerCase()&&(r=render_response,t="",a=!1),"reference"!=t.toLowerCase()&&"ref"!=t.toLowerCase()||(r=render_ref),"rowclass_hhh"==t&&(s=function(e,t,n){$(e).addClass(t[this.api().column("rowclass:name").index()])}),"_xml"==t.slice(-4)&&(t=t.slice(0,-4),r=render_xml),"_md"==t.slice(-3)&&(t=t.slice(0,-3),r=render_markdown),"_sss"==t.slice(-4)&&(t=t.slice(0,-4),r=render_special),"_url"==t.slice(-4)&&(n=!0,t=t.slice(0,-4),r=render_url,a=!1),"_nnn"==t.slice(-4)&&(t=t.slice(0,-4),o.push({column_name:t,filter_type:"range_number_slider"})),"_rrr"==t.slice(-4)&&(t=t.slice(0,-4),o.push({column_name:t,filter_type:"multi_select",select_type:"select2",case_insensitive:"true"})),"_ddd"==t.slice(-4)&&(t=t.slice(0,-4),o.push({column_name:t,filter_type:"range_date",date_format:"dd MM yyyy"})),"_dtf"==t.slice(-4)&&(t=t.slice(0,-4),o.push({column_name:t,filter_type:"range_date",date_format:"dd/mm/yyyy",moment_date_format:"DD/MM/YYYY HH:mm:ss"})),"_hhh"==t.slice(-4)&&(n=!1,t=t.slice(0,-4)),{title:t.replace(/_/g," ").trim(),name:t.replace(/_/g," ").trim(),visible:n,render:r,orderable:a,createdCell:void 0}}),console.log("cols"),console.log(a),console.log("got how many rows?"+n.length),t.counter&&$("#"+t.counter).html(n.length),$("#"+t.tab+" .spinner .msg").html("Drawing results...").show();var l=r.DataTable({dom:t.tableconfig,data:n,columns:a,scrollX:!0,buttons:t.tablebuttons,createdRow:s,configtab:t.tab,popupTemplateID:t.popupTemplateID?t.popupTemplateID:null,popupLookup:t.popupLookup?t.popupLookup:null,sScrollX:"100%",sScrollXInner:"100%",drawCallback:t.map?function(e){update_map(e,this.api(),t)}:null,order:t.order?t.order:[[0,"desc"]]});l.on("draw.dt",function(){$("[id^=ModalCase]").addClass("DO-NOT-PRINT"),$("[id^=ModalResponse]").addClass("DO-NOT-PRINT"),$("button[data-target]:visible").each(function(){var e=$(this).data("target");$(e).removeClass("DO-NOT-PRINT")}),loadnotes()>0&&$(this).dataTable().columns&&$(this).dataTable().columns.adjust()}),o.forEach(function(e){e.column_number=l.column(e.column_name.replace(/_/g," ")+":name").index()}),setTimeout(function(){o.length>0&&(yadcf.init(l,o,"header"),console.log("resizing"),l.columns.adjust())},2e3),$("#"+t.tab).on("click","td",function(){if(void 0!==maplace&&maplace.Loaded){console.log("update map on table click");var e=$(this).closest("tr"),t=(l.row(e),Number(e.attr("class").match(/(?:row-)(\d+)/)[1])+1);console.log("centre on "+t),maplace.ViewOnMap(t)}})}}function draw_results_list(e,t){var n=$("select#"+t.tab),a=$("#"+t.tab).text();n.find("option").remove().end(),$.each(e.transformed.rows_data,function(){n.append($("<option />").val(this.name).text(this.display))}),n.val(a)}function draw_results_buttons(e,t){var n=$("#"+t.tab),a=$("#"+t.variable).text();n.find("a:not(.selectall):not(.clearall)").remove().end(),$.each(e.transformed.rows_data,function(){var e=a.split(",").includes(this.name);n.append($('<a role="button" class="buttonpusher" type="button" data-toggle="button" />').val(this.name).text(this.display).addClass(t.class+" "+(e?" active":"")).attr("config",t.variable).attr("aria-pressed",e.toString()).click(function(){buttonpush(this),refreshLookups()}))})}function draw_results_template(e,t){var n=new showdown.Converter({tables:!0,strikethrough:!0}),a=0;for(var o in"template"===t.type&&$("#"+t.tab+" .results").children().not(".keep").empty().remove(),e.transformed.rows_data)if(e.transformed.rows_data.hasOwnProperty(o)){if(a++,"template"===t.type)var s=$("#"+t.template).clone();else s=$("body");for(var r in e.transformed.rows_data[o])if(e.transformed.rows_data.hasOwnProperty(o)){var l=e.transformed.rows_data[o][r];s.html(s.html().split("####"+r+"####").join(l)),l="_md"==r.slice(-3)?n.makeHtml(l):"_rw"==r.slice(-3)?l:escapeHtml(l),s.html(s.html().split("###"+r+"###").join(l))}if(s.html(s.html().split("###rownum###").join(a)),"template"===t.type&&(s.removeClass("oco_template").attr("id","result_"+o.split(" ").join("_")),$("#"+t.tab+" .results").append(s),$("#"+t.tab+" .results .keep").insertAfter(s)),e.transformed.rows_data[o].step_num){var i=e.transformed.rows_data[o].step_num-1;$("#"+t.tab+" .results .arrow-steps .step").slice(0,i).addClass("done"),$("#"+t.tab+" .results .arrow-steps .step:eq("+i+")").addClass("current")}}var d="";"template"===t.type?d="#"+t.tab+" .results":(d="body",void 0===t.sub&&$(".hideuntilglobal").removeClass("hideuntilglobal")),$(d+" .momentfromnow").each(function(e,t){var n=moment($(t).html(),["YYYY-MM-DD","DD/MM/YYYY HH:mm:ss"],!0);n.isValid()&&$(t).html(n.fromNow()).attr("title",n.format("LLLL")).removeClass("momentfromnow")}),$(d+" .momenttonow").each(function(e,t){var n=moment($(t).html());n.isValid()||(n=moment($(t).html(),"DD/MM/YYYY HH:mm:ss")),n.isValid()&&$(t).html(n.toNow()).attr("title",n.format("LLLL")).removeClass("momenttonow")}),$(d+" .momentlocaldatetime").each(function(e,t){var n=moment($(t).html());n.isValid()||(n=moment($(t).html(),"DD/MM/YYYY HH:mm:ss")),n.isValid()&&$(t).html(n.format("LLLL")).removeClass("momentlocaldatetime")}),$(d+" .momentlocaldate").each(function(e,t){var n=moment($(t).html());n.isValid()||(n=moment($(t).html(),"DD/MM/YYYY HH:mm:ss")),n.isValid()&&$(t).html(n.format("ddd D MMM YYYY")).removeClass("momentlocaldate")}),$(d+" .momentlocaldatenoyear").each(function(e,t){var n=moment($(t).html());n.isValid()||(n=moment($(t).html(),"DD/MM/YYYY HH:mm:ss")),n.isValid()&&$(t).html(n.format("ddd D MMM")).removeClass("momentlocaldate")}),$(d+".slickcarousel").length>0&&$(d+".slickcarousel").slick(),$(d+" .results .money").not(":contains(###)").each(function(e,t){$(t).text(Number($(t).text()).toLocaleString("en"))}).removeClass("money"),void 0===t.sub&&($(d+" .copycursor.unbound").not(":contains(###)").click(function(){copyToClipboard(this)}).removeClass("unbound"),$(d+" .hideswitch.unbound").not(":contains(###)").click(function(){hideswitch(this)}).removeClass("unbound"),$(d+" .tablefilter.unbound").not(":contains(###)").click(function(){tablefilter(this)}).removeClass("unbound"),$(d+" div.oco_country_list.unbound table td:first-child").not(":contains(###)").each(function(){$(this).addClass("flag-icon-"+$(this).html().substring(0,2)),$(this).html($(this).html().slice(2))}),$(d+" div.oco_country_list.unbound").not(":contains(###)").removeClass("unbound")),t.counter&&($("."+t.counter).each(function(){$(this).html(a)}),$("#"+t.counter).html(a))}function draw_results_plotly(e,t){var n,a,o={};switch($.extend(o,t.plotly_layout),n=e.transformed.rows_data,console.log(n),$("#"+t.tab).empty(),t.graph){case"violin":a=$.map(n,function(e){return JSON.parse(e.the_json)}),Plotly.newPlot(t.tab,a,o,{responsive:!0});break;case"stackedbar":console.log("plotly debug"),console.log(t),console.log(n),a=$.map(n,function(e){return{x:["Created","Completed","Open"],y:[e.created,e.completed,e.open],type:"bar",name:e.breakdown,wk:e.wk,barmode:"stack",marker:{color:"#FFC"}}});var s=$.map(a,function(e){return e.wk}).filter(function(e,t,n){return n.indexOf(e)===t}),r=$.map(a,function(e){return e.name}).filter(function(e,t,n){return n.indexOf(e)===t}),l=[{index:0,name:"tangelo",data:["#efa876","#ed9c62","#eb8f4f","#e9833b","#e77728","#d26d25","#be6221","#a9571e","#934c1a","#7e4116"]},{index:1,name:"light sea green",data:["#89d3d3","#76cccc","#62c4c5","#4fbdbe","#3bb6b7","#28afb0","#25a0a0","#219091","#1e8081","#1a7071"]},{index:2,name:"meat brown",data:["#f5d58e","#f3ce7b","#f1c768","#f0c055","#eeb942","#edb230","#d8a22c","#c29228","#ad8223","#97721f"]},{index:3,name:"queen blue",data:["#81aab8","#6c9cac","#578ea1","#428095","#2d7289","#19647e","#175b73","#155268","#13495c","#104051"]}];$.each(a,function(e,t){console.log(t),console.log(s.findIndex(function(e,n,a){return e==t.wk})),t.xaxis="x"+(1+s.findIndex(function(e,n,a){return e==t.wk})),t.marker.color=l[r.findIndex(function(e,n,a){return e==t.name})%4].data,t.showlegend="x1"==t.xaxis});var i=1/s.length;console.log(i),console.log(a),o.barmode="stack",$.each(s,function(e,t){o["xaxis"+(0==e?"":e+1)]={domain:[i*e,i*e+i],tickangle:-45,anchor:"x"+(e+1),title:t}}),console.log("my layout is"),console.log(o),Plotly.newPlot(t.tab,a,o,{responsive:!0});break;case"debug":console.log("plotly debug"),console.log(t),console.log(n);break;case"generic":var d=t.plotly_tracedata?t.plotly_tracedata:{type:"bar"},c=$.map(n,function(e){return e[Object.keys(e)[2]]}).filter(function(e,t,n){return n.indexOf(e)===t});a=$.map(c,function(e){return $.extend({x:[],y:[],name:e},d)}),$.map(n,function(e){a[c.indexOf(e[Object.keys(e)[2]])].x.push(e[Object.keys(e)[0]]),a[c.indexOf(e[Object.keys(e)[2]])].y.push(e[Object.keys(e)[1]])}),Plotly.newPlot(t.tab,a,o,{responsive:!0});break;case"pie":d=t.plotly_tracedata?t.plotly_tracedata:{type:"pie"};a=[$.extend({values:$.map(n,function(e){return e.y}),labels:$.map(n,function(e){return e.series})},d)],Plotly.newPlot(t.tab,a,o,{responsive:!0});break;case"bar":var m={x:$.map(n,function(e){return e.wk}),y:$.map(n,function(e){return e.created}),name:"Created",type:"bar"},u={x:$.map(n,function(e){return e.wk}),y:$.map(n,function(e){return e.completed}),name:"Completed",type:"bar"},p={x:$.map(n,function(e){return e.wk}),y:$.map(n,function(e){return e.open}),name:"Open",type:"bar"};a=[m,u,p],Plotly.newPlot(t.tab,a,o,{responsive:!0});break;case"line":var f=[{type:"scatter",mode:"lines",name:"Total submissions",x:unpack(n,"date"),y:unpack(n,"daily_submissions")},{type:"scatter",mode:"lines",name:"Dash submissions",x:unpack(n,"date"),y:unpack(n,"dash_submissions")},{type:"scatter",mode:"lines",name:"Self submissions",x:unpack(n,"date"),y:unpack(n,"self_submissions")},{type:"scatter",mode:"lines",name:"Service submissions",x:unpack(n,"date"),y:unpack(n,"service_submissions")},{type:"scatter",mode:"lines",name:"Forms submissions",x:unpack(n,"date"),y:unpack(n,"forms_submissions")}];o={title:"Completed cases volume trend",xaxis:{autorange:!0,range:[$("#daterangestart").html(),$("#daterangeend").html()],rangeselector:{buttons:[{count:1,label:"1w",step:"week",stepmode:"backward"},{count:1,label:"1m",step:"month",stepmode:"backward"},{count:6,label:"6m",step:"month",stepmode:"backward"},{step:"all"}]},rangeslider:{range:[$("#daterangestart").html().substring(6,10)+"-"+$("#daterangestart").html().substring(3,5)+"-"+$("#daterangestart").html().substring(0,2),$("#daterangeend").html().substring(6,10)+"-"+$("#daterangeend").html().substring(3,5)+"-"+$("#daterangeend").html().substring(0,2)]},type:"date"},yaxis:{autorange:!0,type:"linear"}},Plotly.newPlot(t.tab,f,o,{responsive:!0});break;default:$("#"+t.tab+" .spinner .msg").html("Invalid plotly graph type: "+t.graph).show()}}function postprocess(e){var t=jQuery.parseHTML(e);$(t).find(".momentfromnow").each(function(e,t){var n=moment($(t).html(),["YYYY-MM-DD","DD/MM/YYYY HH:mm:ss"],!0);n.isValid()&&$(t).html(n.fromNow()).attr("title",n.format("LLLL")).removeClass("momentfromnow")}),$(t).find(".momenttonow").each(function(e,t){var n=moment($(t).html());n.isValid()||(n=moment($(t).html(),"DD/MM/YYYY HH:mm:ss")),n.isValid()&&$(t).html(n.toNow()).attr("title",n.format("LLLL")).removeClass("momenttonow")}),$(t).find(".momentlocaldatetime").each(function(e,t){var n=moment($(t).html());n.isValid()||(n=moment($(t).html(),"DD/MM/YYYY HH:mm:ss")),n.isValid()&&$(t).html(n.format("LLLL")).removeClass("momentlocaldatetime")}),$(t).find(".momentlocaldate").each(function(e,t){var n=moment($(t).html());n.isValid()||(n=moment($(t).html(),"DD/MM/YYYY HH:mm:ss")),n.isValid()&&$(t).html(n.format("ddd D MMM YYYY")).removeClass("momentlocaldate")}),$(t).find(".momentlocaldatenoyear").each(function(e,t){var n=moment($(t).html());n.isValid()||(n=moment($(t).html(),"DD/MM/YYYY HH:mm:ss")),n.isValid()&&$(t).html(n.format("ddd D MMM")).removeClass("momentlocaldate")}),$(t).find(".results .money").not(":contains(###)").each(function(e,t){$(t).text(Number($(t).text()).toLocaleString("en"))}).removeClass("money"),$(t).find(".copycursor.unbound").not(":contains(###)").click(function(){copyToClipboard(this)}).removeClass("unbound"),$(t).find(".hideswitch.unbound").not(":contains(###)").click(function(){hideswitch(this)}).removeClass("unbound"),$(t).find(".tablefilter.unbound").not(":contains(###)").click(function(){tablefilter(this)}).removeClass("unbound"),$(t).find("div.oco_country_list.unbound table td:first-child").not(":contains(###)").each(function(){$(this).addClass("flag-icon-"+$(this).html().substring(0,2)),$(this).html($(this).html().slice(2))}),$(t).find("div.oco_country_list.unbound").not(":contains(###)").removeClass("unbound");var n=new showdown.Converter({tables:!0,strikethrough:!0});return $(t).find(".newmarkdown").each(function(e,a){if(o=n.makeHtml($(a).html()),""!==o){var s=$("<span>"+o+"</span>");$("a:not(target)",t).attr("target","_blank"),o=s.html()}$(a).html(o).removeClass("newmarkdown")}),$(t).html()}function update_map(e,t,n){console.log("update map");var a=t.column("view:name").index(),o=t.column("maplocation:name").index(),s=t.column("mapicon:name").index();if(void 0!==o){var r={locations:[]};$("#"+n.map).show();var l=[];t.columns().every(function(){l.push($(this.header()).children(".DataTables_sort_wrapper").text())}),t.rows({page:"all",search:"applied"}).every(function(e,t,i){var d=this.data();if(2==d[o].split(", ").length&&"0, 0"!=d[o]&&", "!=d[o]){var c={rowID:i,tableID:n.tab,lat:d[o].split(", ")[0],lon:d[o].split(", ")[1],html:'<a target="_parent" href="'+d[a]+'">'+d[0]+"</a>",icon:void 0!==s?d[s]:""};n.maptemplate?(c.html=$("#"+n.maptemplate).html(),l.forEach(function(e,t){c.html=c.html.split("###"+e+"###").join(d[t])})):l.forEach(function(e,t){c.html=c.html+"<br/><b>"+e+"</b>: "+d[t]}),c.html=postprocess(c.html),r.locations.push(c);var m=this.node();$(m).removeClass(function(e,t){return(t.match(/\brow-\d+/g)||[]).join(" ")}),$(m).addClass("row-"+i)}}),maplace.Loaded?maplace.SetLocations(r.locations,!0):maplace.Load({locations:r.locations})}else $("#"+n.map).hide()}function draw_results(e,t){if($("#"+t.tab+" .spinner .msg").html("Processing results...").show(),$("#"+t.tab+" .results").children().not(".keep").empty().remove(),t.map&&void 0===maplace&&(maplace=new Maplace({shared:{zoom:16},directions_options:{travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.METRIC,optimizeWaypoints:!1,provideRouteAlternatives:!1,avoidHighways:!1,avoidTolls:!1},map_options:{set_center:t.map.center,zoom:t.map.zoom},afterOpenInfowindow:maplaceHiglightRow}).Load()),$.isEmptyObject(e.transformed.rows_data))$("#"+t.tab+" .spinner .msg").html("No data").show(),t.nodata&&$("#"+t.nodata).show().removeClass("hidden"),t.map&&$("#"+t.map).hide();else{switch(t.nodata&&$("#"+t.nodata).hide().addClass("hidden"),t.type){case"global":draw_results_template(e,t);break;case"table":draw_results_table(e,t);break;case"template":draw_results_template(e,t);break;case"selectlist":draw_results_list(e,t);break;case"buttons":draw_results_buttons(e,t);break;case"plotly":draw_results_plotly(e,t);break;default:$("#"+t.tab+" .spinner .msg").html("Invalid configuration template - "+t.type).show()}if("object"==typeof t.sub)for(var n=0;n<t.sub.length;n++)for(var a=0;a<e.transformed.select_data.length;a++)get_data(t.sub[n],e.transformed.rows_data[a])}$("#"+t.tab+" .spinner").hide()}function log_error(e,t){$("#spinnermsg").html("Error attempting "+e+" : "+t).show()}function run_lookup(e,t,n,a){var o,s,r;if(void 0===parent.FS)return alert("Unable to find AchieveForms session id");if(r=void 0!==parent.FS&&null!==parent.FS&&null!==(s=parent.FS.Auth)?s.session["auth-session"]:void 0){o={stopOnFailure:!0,usePHPIntegrations:!0,user:{},formId:"",formValues:{"Section 1":{}},isPublished:!1,formName:"",tokens:{port:"",host:"",site_url:"",site_path:"",site_origin:"",user_agent:"",site_protocol:"",session_id:"",product:"",formLanguage:"",authenticationType:"",isAuthenticated:!0,api_url:"",transactionReference:"",transaction_status:"",published:!1,timeZone:""},env_tokens:{weburl:""},site:"",created:"",reference:"",formUri:""},$.extend(o.tokens,t);var l={};return $.each(t,function(e,t){l[e]={name:e,value:t}}),$.extend(o.formValues["Section 1"],l),$.ajax({type:"POST",contentType:"application/json",url:"/apibroker/runLookup?app_name=AchieveForms&sid="+r+"&id="+e,data:JSON.stringify(o),success:function(e){var t;return t=e.integration,console.log(t),t&&t.transformed?n(t):a()},error:function(e){return console.log(e),a()}})}alert("Unable to find AchieveForms session id")}$(document).ready(function(){if(""!==$("#pagetitle").text()&&(window.parent.document.title=$("#pagetitle").text()),void 0!==parent.FS){var e=JSON.parse($("#lookup_config").text()).map(e=>e.type),t=[],n="oco.js";void 0===$('script[src$="'+n+'"]').attr("src")&&(n="oco.min.js"),void 0===$('script[src$="'+n+'"]').attr("src")&&(n="oco.beta.js"),void 0===$('script[src$="'+n+'"]').attr("src")&&(n="temp.js");var a=$('script[src$="'+n+'"]').attr("src").replace(n,"");$.ajaxSetup({cache:!0}),t.push(a+"moment/moment.min.js"),t.push(a+"showdown/showdown.min.js"),e.includes("calendar")&&($("<link/>",{rel:"stylesheet",type:"text/css",href:a+"fullcal/5.0.1/lib/main.css"}).appendTo("head"),t.push(a+"fullcal/5.0.1/lib/main.js")),e.includes("plotly")&&t.push(a+"plotly/plotly-latest.min.js"),e.includes("table")&&(t.push(a+"datatables/datatables.min.js"),t.push(a+"datatables/datetime-moment.js"),t.push(a+"datatables/select2.min.js"),t.push(a+"datatables/ellipsis.js"),t.push(a+"datatables/jquery.dataTables.yadcf.js")),t.push(a+"maplace/maplace.min.js"),t.push(a+"daterangepicker/daterangepicker.js"),console.log("loading scripts"),load_a_script(t.reverse())}else $("#console").append("Unable to find AchieveForms session id<br/>")});var tablepages={};function togglePrint(){if(0==$(".oco_pagebuilder.printready").length){$("#printhelp div.printmode").addClass("on");for(var e=0;e<document.styleSheets.length;e++){var t=document.styleSheets[e];if(t.href&&t.href.indexOf("bootstrap")>0)for(var n=0;n<t.rules.length;n++){var a=t.rules[n];if(a.conditionText&&"print"==a.conditionText)for(var o=0;o<a.cssRules.length;o++){"*"==a.cssRules[o].selectorText&&a.deleteRule(o)}}}$.fn.dataTable.tables().forEach(function(e){var t=$("#"+e.id).DataTable();void 0!==t.page.info()&&(tablepages[e.id]=t.page.info().length,t.page.len(5e3).draw())}),$(parent.document).find("#toolbar").hide(),$(parent.document).find("#header").hide(),$(parent.document).find("#navigation").hide(),$(parent.document).find(".footer").hide(),$(".oco_pagebuilder").addClass("printready"),$(".tab-content").removeClass("col-md-10").addClass("col-md-12")}else $("#printhelp div.printmode").removeClass("on"),$.fn.dataTable.tables().forEach(function(e){var t=$("#"+e.id).DataTable();void 0!==t.page.info()&&t.page.len(tablepages[e.id]).draw()}),$(parent.document).find("#toolbar").show(),$(parent.document).find("#header").show(),$(parent.document).find("#navigation").show(),$(parent.document).find(".footer").show(),$(".oco_pagebuilder").removeClass("printready"),$(".tab-content").removeClass("col-md-12").addClass("col-md-10")}$.fn.rotate=function(e){var t,n,a=$(this),o=0;function s(e){var n=!1,a=document.createElement("div").style;return $.each(t,function(t,o){""===a[o.replace(/\-/g,"")+e]&&(n=!0)}),n}function r(e,n){var a={};return s.transform?($.each(t,function(t,o){a[o.toLowerCase()+e]=n||""}),a):a}return t=["-Webkit-","-Moz-","-O-","-ms-",""],n=$.extend({startDeg:!1,endDeg:360,duration:1,count:1,easing:"linear",animate:{},forceJS:!1},e),s.transform=s("Transform"),s.transition=s("Transition"),n.endDeg*=n.count,n.duration*=n.count,s.transition&&!n.forceJS?(/Firefox/.test(navigator.userAgent)&&(o=e&&e.animate||!(!1===n.startDeg||n.startDeg>=0)?25:0),a.queue(function(e){!1!==n.startDeg&&a.css(r("transform","rotate("+n.startDeg+"deg)")),setTimeout(function(){a.css(r("transition","all "+n.duration+"s "+n.easing)).css(r("transform","rotate("+n.endDeg+"deg)")).css(n.animate)},o),setTimeout(function(){a.css(r("transition")),n.persist||a.css(r("transform")),e()},1e3*n.duration-o)})):(!1===n.startDeg&&(n.startDeg=a.data("rotated")||0),n.animate.perc=100,a.animate(n.animate,{duration:1e3*n.duration,easing:$.easing[n.easing]?n.easing:"",step:function(e,t){var o;"perc"===t.prop&&(o=n.startDeg+(n.endDeg-n.startDeg)*e/100,a.css(r("transform","rotate("+o+"deg)")).css("filter",function(e){var t,n,a;return s.transform?"":(t=e>=0?Math.PI*e/180:Math.PI*(360+e)/180,"progid:DXImageTransform.Microsoft.Matrix(M11="+(n=Math.cos(t))+",M12="+-(a=Math.sin(t))+",M21="+a+",M22="+n+',SizingMethod="auto expand")')}(o)))},complete:function(){if(n.persist)for(;n.endDeg>=360;)n.endDeg-=360;else n.endDeg=0,a.css(r("transform"));a.css("perc",0).data("rotated",n.endDeg)}})),a};